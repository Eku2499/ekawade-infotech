<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bookings Admin</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; background:#f6f9ff; color:#003366 }
    table { width:100%; border-collapse: collapse; margin-top: 1rem }
    th, td { padding: 0.5rem; border: 1px solid #ddd; text-align: left }
    th { background: #e6f0ff }
    button { padding: 0.4rem 0.6rem; background: #0055aa; color: white; border: none; border-radius:4px }
    button.delete { background: #c33 }
    .controls { display:flex; gap:1rem; align-items:center }
  </style>
</head>
<body>
  <h1>Bookings Admin</h1>
  <div class="controls">
    <input id="search" placeholder="Search name, email, date or phone" style="flex:1;padding:0.4rem;border-radius:4px;border:1px solid #ccc" />
    <select id="perPage"><option>5</option><option selected>10</option><option>25</option></select>
    <button id="refresh">Search</button>
    <a href="/export" id="exportLink">Export CSV</a>
    <span id="status"></span>
  </div>
  <table id="bookingsTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Email</th><th>Date</th><th>Phone</th><th>Created</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:0.5rem;display:flex;gap:0.5rem;align-items:center">
    <button id="prev">Prev</button>
    <span id="pageInfo"></span>
    <button id="next">Next</button>
  </div>
<script>
let currentPage = 1;
async function fetchBookings(){
  const status = document.getElementById('status');
  const perPage = parseInt(document.getElementById('perPage').value, 10) || 10;
  const search = document.getElementById('search').value.trim();
  status.textContent = 'Loading...';
  try{
    const res = await fetch(`/bookings?page=${currentPage}&per_page=${perPage}&search=${encodeURIComponent(search)}`);
    const data = await res.json();
    const tbody = document.querySelector('#bookingsTable tbody');
    tbody.innerHTML = '';
    data.bookings.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${b.id}</td><td>${b.name}</td><td>${b.email}</td><td>${b.date}</td><td>${b.phone}</td><td>${b.created_at}</td><td><button class="delete" data-id="${b.id}">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('pageInfo').textContent = `Page ${data.page} of ${data.total_pages} â€” ${data.total} total`;
    status.textContent = '';
  }catch(e){
    status.textContent = 'Failed to load bookings';
  }
}

document.getElementById('refresh').addEventListener('click', function(){ currentPage = 1; fetchBookings(); });

document.querySelector('#bookingsTable tbody').addEventListener('click', async (e)=>{
  if(e.target.matches('button.delete')){
    const id = e.target.dataset.id;
    if(!confirm('Delete booking '+id+'?')) return;
    try{
      const res = await fetch('/bookings/'+id, { method: 'DELETE' });
      const data = await res.json();
      if(res.ok) fetchBookings(); else alert(data.message || 'Delete failed');
    }catch(err){ alert('Network error') }
  }
});

// set export link to absolute path
document.getElementById('exportLink').href = '/export';

document.getElementById('prev').addEventListener('click', function(){ if(currentPage>1){ currentPage--; fetchBookings(); }});
document.getElementById('next').addEventListener('click', function(){ currentPage++; fetchBookings(); });

// initial load
fetchBookings();
</script>
</body>
</html>